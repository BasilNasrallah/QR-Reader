<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>QR Scanner Pro</title>

    <style>
        html, body {
            margin: 0;
            height: 100%;
        }

        body {
            display: grid;
            grid-template-rows: auto /* header */
            40vh /* camera grid */
            auto /* manual bar */
            1fr /* log */
            auto /* footer */
            ;
            overflow: hidden;
            font-family: sans-serif;
            background: #fafafa;
            color: #333;
        }

        h1 {
            margin: 0;
            padding: 12px;
            background: #333;
            color: #fff;
            position: relative;
            text-align: center;
        }

        #configToggle {
            position: absolute;
            top: 12px;
            right: 12px;
            background: transparent;
            border: none;
            font-size: 24px;
            color: #fff;
            cursor: pointer;
        }

            #configToggle::after {
                content: attr(data-tooltip);
                position: absolute;
                top: -32px;
                right: 0;
                background: rgba(0,0,0,0.8);
                color: #fff;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 0.85rem;
                white-space: nowrap;
                opacity: 0;
                pointer-events: none;
                transition: opacity .2s;
            }

            #configToggle:hover::after {
                opacity: 1;
            }

        #configPanel {
            display: none;
            position: absolute;
            top: 48px;
            right: 12px;
            background: #fff;
            padding: 12px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            font-size: 0.9rem;
            color: #333;
            z-index: 10;
        }

            #configPanel label {
                display: block;
                margin-bottom: 8px;
            }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
            gap: 12px;
            padding: 12px;
            background: #fff;
            overflow-y: auto;
        }

        .terminalBox {
            display: flex;
            flex-direction: column;
            border: 3px solid #ccc;
            border-radius: 8px;
            background: #000;
            cursor: pointer;
            position: relative;
            transition: border-color .2s, box-shadow .2s;
        }

            .terminalBox[aria-selected="true"] {
                border-color: #ff8a00;
                animation: neon 1.5s ease-in-out infinite alternate;
            }

        @keyframes neon {
            from {
                box-shadow: 0 0 4px rgba(255,138,0,0.8);
            }

            to {
                box-shadow: 0 0 12px rgba(255,138,0,0.8);
            }
        }

        .terminalTitle {
            background: #222;
            color: #fff;
            padding: 6px;
            text-align: center;
        }

        .videoContainer {
            position: relative;
            flex: 1;
            overflow: hidden;
        }

            .videoContainer video {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

        .spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 32px;
            height: 32px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            transform: translate(-50%,-50%);
            z-index: 2;
        }

        @keyframes spin {
            to {
                transform: translate(-50%,-50%) rotate(360deg);
            }
        }

        .spinner.hide {
            display: none;
        }

        .scanArea {
            position: absolute;
            top: 20%;
            left: 20%;
            width: 60%;
            height: 60%;
            border: 2px dashed red;
            resize: both;
            overflow: auto;
            cursor: move;
            z-index: 3;
        }

        .scanLine {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: rgba(255,0,0,0.7);
            animation: scanAnim 2s linear infinite;
        }

        .videoContainer.scanning .scanLine {
            display: block;
        }

        @keyframes scanAnim {
            from {
                top: 0
            }

            to {
                top: calc(100% - 2px);
            }
        }

        .feedback {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%,-50%) scale(0);
            font-size: 4vw;
            transition: transform .2s;
            pointer-events: none;
            z-index: 4;
        }

            .feedback.show {
                transform: translate(-50%,-50%) scale(1);
            }

            .feedback.success {
                color: #4caf50;
            }

            .feedback.error {
                color: #f44336;
            }

        .manualContainer {
            padding: 8px;
            text-align: center;
            background: #fff;
            border-top: 1px solid #ddd;
        }

        #manualInput {
            width: 200px;
            padding: 6px;
            margin-right: 6px;
        }

        #logContainer {
            overflow-y: auto;
            padding: 12px;
            background: #fff;
            border-top: 1px solid #ddd;
        }

        #exportBtn {
            margin-bottom: 8px;
            padding: 6px 12px;
            cursor: pointer;
        }

        #logTable {
            width: 100%;
            border-collapse: collapse;
        }

            #logTable th, #logTable td {
                border: 1px solid #ccc;
                padding: 4px;
                text-align: left;
            }

        /* Footer */
        footer {
            background: #333;
            color: #fff;
            text-align: center;
            padding: 8px;
            font-size: 0.9rem;
        }

            footer a {
                color: #4caf50;
                text-decoration: none;
            }

                footer a:hover {
                    text-decoration: underline;
                }
    </style>
</head>

<body>

    <h1>
        Bus Terminals Scanner
        <button id="configToggle" data-tooltip="Settings">⚙️</button>
        <div id="configPanel">
            <label>
                <input type="checkbox" id="voiceToggle" checked />
                Voice Feedback
            </label>
            <label>
                Cooldown (ms):
                <input type="number" id="cooldown" value="1000" min="0" step="100" />
            </label>
            <label>
                Profile:
                <select id="profileSelect">
                    <option value="QR_CODE">QR Code</option>
                    <option value="EAN_13">EAN‑13</option>
                    <option value="CODE_128">Code 128</option>
                    <option value="DATA_MATRIX">Data Matrix</option>
                </select>
            </label>
        </div>
    </h1>

    <div class="grid" role="group" aria-label="Terminals">
        <!-- repeat for each of the 4 terminals -->
        <div class="terminalBox" data-index="0" aria-selected="false" tabindex="0">
            <div class="terminalTitle">BUS-TERMINAL-AAA</div>
            <div class="videoContainer">
                <div class="spinner"></div>
                <div class="scanLine"></div>
                <div class="scanArea" draggable="true"></div>
                <video id="video0" autoplay playsinline muted></video>
                <div class="feedback" id="fb0"></div>
            </div>
        </div>
        <div class="terminalBox" data-index="1" aria-selected="false" tabindex="0">
            <div class="terminalTitle">BUS-TERMINAL-BBB</div>
            <div class="videoContainer">
                <div class="spinner"></div>
                <div class="scanLine"></div>
                <div class="scanArea" draggable="true"></div>
                <video id="video1" autoplay playsinline muted></video>
                <div class="feedback" id="fb1"></div>
            </div>
        </div>
        <div class="terminalBox" data-index="2" aria-selected="false" tabindex="0">
            <div class="terminalTitle">BUS-TERMINAL-CCC</div>
            <div class="videoContainer">
                <div class="spinner"></div>
                <div class="scanLine"></div>
                <div class="scanArea" draggable="true"></div>
                <video id="video2" autoplay playsinline muted></video>
                <div class="feedback" id="fb2"></div>
            </div>
        </div>
        <div class="terminalBox" data-index="3" aria-selected="false" tabindex="0">
            <div class="terminalTitle">BUS-TERMINAL-DDD</div>
            <div class="videoContainer">
                <div class="spinner"></div>
                <div class="scanLine"></div>
                <div class="scanArea" draggable="true"></div>
                <video id="video3" autoplay playsinline muted></video>
                <div class="feedback" id="fb3"></div>
            </div>
        </div>
    </div>

    <div class="manualContainer">
        <input id="manualInput" placeholder="Enter/Paste QR…" />
        <button id="manualBtn">Submit</button>
    </div>

    <div id="logContainer">
        <button id="exportBtn">Export Log CSV</button>
        <table id="logTable">
            <thead>
                <tr><th>Time</th><th>Terminal</th><th>Code</th><th>Result</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <footer>
        © <span id="year"></span>
        <a href="https://www.linkedin.com/in/basil-nasrallah/" target="_blank">Basil Nasrallah</a>. All rights reserved.
    </footer>

    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <script>
        (async () => {
            // current year
            document.getElementById('year').textContent = new Date().getFullYear();

            const titles = ['BUS-TERMINAL-AAA', 'BUS-TERMINAL-BBB', 'BUS-TERMINAL-CCC', 'BUS-TERMINAL-DDD'];
            const boxes = Array.from(document.querySelectorAll('.terminalBox'));
            let selected = null, scanning = false,
                voiceOn = true, cooldown = 1000, specFormat = 'QR_CODE',
                femaleVoice = null, log = [];

            // Settings panel
            document.getElementById('configToggle').onclick = () => {
                const panel = document.getElementById('configPanel');
                panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
            };
            document.getElementById('voiceToggle').onchange = e => voiceOn = e.target.checked;
            document.getElementById('cooldown').oninput = e => cooldown = +e.target.value || 0;
            document.getElementById('profileSelect').onchange = e => specFormat = e.target.value;

            // ARIA live region
            const ariaLive = document.createElement('div');
            ariaLive.setAttribute('aria-live', 'assertive');
            ariaLive.style.position = 'absolute'; ariaLive.style.left = '-9999px';
            document.body.append(ariaLive);
            function ariaAnnounce(msg) { ariaLive.textContent = msg; }

            // Terminal selection
            boxes.forEach(b => {
                b.addEventListener('click', selectTerminal);
                b.addEventListener('keydown', e => { if (e.key === 'Enter') selectTerminal.call(b); });
            });
            function selectTerminal() {
                boxes.forEach(x => {
                    x.setAttribute('aria-selected', 'false');
                    x.querySelector('.feedback').className = 'feedback';
                    x.querySelector('.videoContainer').classList.remove('scanning');
                });
                selected = +this.dataset.index;
                this.setAttribute('aria-selected', 'true');
                this.querySelector('.videoContainer').classList.add('scanning');
                scanning = false;
                ariaAnnounce(`${titles[selected]} selected.`);
            }

            // Text‑to‑speech
            speechSynthesis.onvoiceschanged = () => {
                const vs = speechSynthesis.getVoices();
                femaleVoice = vs.find(v => /female|zira|samantha|victoria/i.test(v.name))
                    || vs.find(v => v.lang.startsWith('en')) || vs[0];
            };
            function speak(txt) {
                if (!voiceOn) return;
                speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(txt);
                if (femaleVoice) u.voice = femaleVoice;
                speechSynthesis.speak(u);
            }

            // Camera setup
            await navigator.mediaDevices.getUserMedia({ video: true }).catch(() => null);
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            boxes.forEach((b, i) => {
                const vid = b.querySelector('video');
                vid.srcObject = stream;
                vid.onloadeddata = () => b.querySelector('.spinner').classList.add('hide');
            });

            // QR scanning
            const reader = new ZXing.BrowserMultiFormatReader();
            reader.decodeFromVideoDevice(null, 'video0', (res, err) => {
                if (res && selected !== null && !scanning) {
                    scanning = true;
                    handleScan(res.text.trim().toUpperCase());
                }
            });

            // Manual submit
            document.getElementById('manualBtn').onclick = () => {
                const code = document.getElementById('manualInput').value.trim().toUpperCase();
                if (code && selected !== null) handleScan(code);
            };

            // Logging
            function addLog(idx, code, ok) {
                log.push([new Date().toLocaleTimeString(), titles[idx], code, ok ? '✔️' : '❌']);
                const tr = document.createElement('tr');
                tr.innerHTML = `
            <td>${log.at(-1)[0]}</td>
            <td>${titles[idx]}</td>
            <td>${code}</td>
            <td>${ok ? '✔️' : '❌'}</td>`;
                document.querySelector('#logTable tbody').append(tr);
            }
            document.getElementById('exportBtn').onclick = () => {
                const csv = [['Time', 'Terminal', 'Code', 'Result'], ...log]
                    .map(r => r.map(c => `"${c}"`).join(',')).join('\r\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'scan_log.csv'; a.click();
            };

            // Scan handler
            function handleScan(code) {
                const fb = document.getElementById('fb' + selected);
                fb.className = 'feedback';
                const full = titles[selected], suf = full.split('-').pop();
                const ok = code === full || code === suf || code.endsWith(suf);
                fb.textContent = ok ? '✓' : '✕';
                fb.classList.add(ok ? 'success' : 'error', 'show');
                speak(ok ? 'Welcome' : 'Denied');
                addLog(selected, code, ok);
                ariaAnnounce(`Scan ${ok ? 'successful' : 'denied'} for ${full}.`);
                setTimeout(() => {
                    fb.className = 'feedback';
                    boxes[selected].setAttribute('aria-selected', 'false');
                    boxes[selected].querySelector('.videoContainer').classList.remove('scanning');
                    selected = null; scanning = false;
                }, cooldown);
            }
        })();
    </script>
</body>
</html>
